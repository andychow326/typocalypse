name: CI
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
on:
  push:
    branches:
      - master
jobs:
  build-and-push-docker-images:
    name: Build and Push Docker Images
    runs-on: macos-12
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup docker (missing on MacOS)
        if: runner.os == 'macos'
        run: |
          brew update
          brew install docker
          colima start

          # For testcontainers to find the Colima socket
          # https://github.com/abiosoft/colima/blob/main/docs/FAQ.md#cannot-connect-to-the-docker-daemon-at-unixvarrundockersock-is-the-docker-daemon-running
          sudo ln -sf $HOME/.colima/default/docker.sock /var/run/docker.sock
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Install Godot 4.1.2
        run: |
          brew update
          brew install --cask https://raw.githubusercontent.com/Homebrew/homebrew-cask/603e5b28015afc43d73cbb9d6cd310444ca16bd0/Casks/g/godot.rb
      - name: Setup client (development)
        if: github.ref_name == 'master'
        run: |
          cp client/config_development.gd client/config.gd
      - name: Setup client (production)
        if: github.ref_name == 'production'
        run: |
          cp client/config_production.gd client/config.gd
      - name: Build client
        run: |
          godot --headless --path client --export-release Web build/index.html
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build and push client
        uses: docker/build-push-action@v5
        with:
          context: client
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/typocalypse-client:git-${{ github.sha }}
      - name: Build and push server
        uses: docker/build-push-action@v5
        with:
          context: server
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/typocalypse-server:git-${{ github.sha }}
